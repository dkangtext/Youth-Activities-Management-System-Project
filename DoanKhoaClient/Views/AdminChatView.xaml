<Window
    x:Class="DoanKhoaClient.Views.AdminChatView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="clr-namespace:DoanKhoaClient.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:DoanKhoaClient.Views"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:vm="clr-namespace:DoanKhoaClient.ViewModels"
    Title="Quản Lý Chat"
    MinWidth="1024"
    MinHeight="768"
    WindowStartupLocation="CenterScreen"
    WindowState="Maximized"
    mc:Ignorable="d">

    <!--  Giữ nguyên Resources từ UserChatView  -->
    <Window.Resources>
        <!--  Sao chép các Resources từ UserChatView  -->
        <converters:TimeZoneConverter x:Key="TimeZoneConverter" />
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter" />
        <converters:StringToBoolConverter x:Key="StringToBoolConverter" />
        <converters:CurrentUserConverter x:Key="CurrentUserConverter" />
        <converters:NotCurrentUserConverter x:Key="NotCurrentUserConverter" />
        <converters:AttachmentTypeToVisibilityConverter x:Key="AttachmentTypeToVisibilityConverter" />
        <converters:MessageTypeToVisibilityConverter x:Key="MessageTypeToVisibilityConverter" />
        <converters:FileIconConverter x:Key="FileIconConverter" />
        <converters:FileSizeConverter x:Key="FileSizeConverter" />
        <converters:ConversationTitleConverter x:Key="ConversationTitleConverter" />
        <!--  Thêm vào Window.Resources trong AdminChatView.xaml  -->
        <Style x:Key="CurrentUserMessageStyle" TargetType="Border">
            <Setter Property="Background" Value="#E3F2FD" />
            <Setter Property="BorderBrush" Value="#BBDEFB" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="10,0,10,10" />
            <Setter Property="Padding" Value="10" />
            <Setter Property="Margin" Value="50,5,10,5" />
            <Setter Property="HorizontalAlignment" Value="Right" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect
                        BlurRadius="4"
                        Opacity="0.2"
                        ShadowDepth="1"
                        Color="#000000" />
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="OtherUserMessageStyle" TargetType="Border">
            <Setter Property="Background" Value="#F5F5F5" />
            <Setter Property="BorderBrush" Value="#E0E0E0" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="0,10,10,10" />
            <Setter Property="Padding" Value="10" />
            <Setter Property="Margin" Value="10,5,50,5" />
            <Setter Property="HorizontalAlignment" Value="Left" />
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect
                        BlurRadius="4"
                        Opacity="0.2"
                        ShadowDepth="1"
                        Color="#000000" />
                </Setter.Value>
            </Setter>
        </Style>


        <Style x:Key="SendButtonStyle" TargetType="{x:Type Button}">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1" />
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                To="1.2"
                                Duration="0:0:0.1" />
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                To="1.2"
                                Duration="0:0:0.1" />
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                                To="1"
                                Duration="0:0:0.1" />
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                                To="1"
                                Duration="0:0:0.1" />
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="MenuItemStyle" TargetType="{x:Type StackPanel}">
            <Setter Property="Cursor" Value="Hand" />
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <TransformGroup>
                        <ScaleTransform ScaleX="1" ScaleY="1" />
                        <TranslateTransform />
                    </TransformGroup>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <EventTrigger RoutedEvent="MouseEnter">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                To="1.05"
                                Duration="0:0:0.1" />
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                To="1.05"
                                Duration="0:0:0.1" />
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(TranslateTransform.X)"
                                To="3"
                                Duration="0:0:0.1" />
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
                <EventTrigger RoutedEvent="MouseLeave">
                    <BeginStoryboard>
                        <Storyboard>
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleX)"
                                To="1"
                                Duration="0:0:0.1" />
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[0].(ScaleTransform.ScaleY)"
                                To="1"
                                Duration="0:0:0.1" />
                            <DoubleAnimation
                                Storyboard.TargetProperty="(UIElement.RenderTransform).(TransformGroup.Children)[1].(TranslateTransform.X)"
                                To="0"
                                Duration="0:0:0.1" />
                        </Storyboard>
                    </BeginStoryboard>
                </EventTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="NavigationButtonStyle" TargetType="{x:Type Button}">
            <Setter Property="Background" Value="Transparent" />
            <Setter Property="BorderThickness" Value="0" />
            <Setter Property="Padding" Value="0" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="{x:Type Button}">
                        <ContentPresenter />
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Window.DataContext>
        <vm:AdminChatViewModel />
    </Window.DataContext>

    <Window.Triggers>
        <EventTrigger RoutedEvent="Window.Loaded">
            <BeginStoryboard>
                <Storyboard>
                    <DoubleAnimation
                        Storyboard.TargetName="AdminChat_Background"
                        Storyboard.TargetProperty="Opacity"
                        From="0"
                        To="1"
                        Duration="0:0:0.5" />
                    <ThicknessAnimation
                        Storyboard.TargetName="AdminChat_Background"
                        Storyboard.TargetProperty="Margin"
                        From="0,30,0,0"
                        To="0,0,0,0"
                        Duration="0:0:0.5">
                        <ThicknessAnimation.EasingFunction>
                            <QuadraticEase EasingMode="EaseOut" />
                        </ThicknessAnimation.EasingFunction>
                    </ThicknessAnimation>
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </Window.Triggers>

    <Grid x:Name="AdminChat_Background" Opacity="0">
        <Grid.Background>
            <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                <GradientStop Offset="0.67" Color="#FFF6FCFF" />
                <GradientStop Offset="1" Color="#FFDBF3FF" />
            </LinearGradientBrush>
        </Grid.Background>
        <Grid Width="1440" Height="1024">

            <Border
                x:Name="Admin_Chat_Dashboard"
                Width="288"
                Height="942"
                Margin="43,0,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Center"
                BorderBrush="Black"
                CornerRadius="10,10,10,10">
                <Border.Background>
                    <LinearGradientBrush StartPoint="0.5,0" EndPoint="0.5,1">
                        <GradientStop Offset="0.04" Color="#FFF6FCFF" />
                        <GradientStop Offset="0.46" Color="#FFDBF3FF" />
                        <GradientStop Offset="0.937" Color="#FF87ACCD" />
                    </LinearGradientBrush>
                </Border.Background>
            </Border>

            <!--  Home Menu Item  -->
            <StackPanel>
                <Button
                    x:Name="SidebarHomeButton"
                    Width="160"
                    Height="30"
                    Margin="102,203,0,0"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="SidebarHomeButton_Click"
                    Cursor="Hand"
                    Style="{StaticResource NavigationButtonStyle}">
                    <StackPanel Orientation="Horizontal" Style="{StaticResource MenuItemStyle}">
                        <Image
                            x:Name="HomePage_iHome"
                            Width="30"
                            Height="30"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Source="/Views/Images/home.png" />
                        <Label
                            x:Name="HomePage_lbHome"
                            Width="108"
                            Height="30"
                            Margin="30,0,0,0"
                            Padding="0,0,0,0"
                            HorizontalAlignment="Left"
                            VerticalAlignment="Top"
                            Content="Home"
                            FontFamily="Segoe UI"
                            FontSize="20"
                            FontWeight="Bold"
                            Foreground="Black" />
                    </StackPanel>
                </Button>
            </StackPanel>
            <Button
                x:Name="SidebarChatButton"
                Width="160"
                Height="30"
                Margin="102,279,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="Transparent"
                BorderThickness="0"
                Click="SidebarChatButton_Click"
                Cursor="Hand"
                Style="{StaticResource NavigationButtonStyle}">
                <StackPanel Orientation="Horizontal" Style="{StaticResource MenuItemStyle}">
                    <Image
                        x:Name="HomePage_iChat"
                        Width="30"
                        Height="30"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Source="/Views/Images/chat_bubble.png" />
                    <Label
                        x:Name="HomePage_lbChat"
                        Width="108"
                        Height="30"
                        Margin="30,0,0,0"
                        Padding="0,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Content="Chat"
                        FontFamily="Segoe UI"
                        FontSize="20"
                        FontWeight="Bold" />
                </StackPanel>
            </Button>
            <Button
                x:Name="SidebarActivitiesButton"
                Width="160"
                Height="30"
                Margin="102,354,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="Transparent"
                BorderThickness="0"
                Click="SidebarActivitiesButton_Click"
                Cursor="Hand"
                Style="{StaticResource NavigationButtonStyle}">
                <StackPanel Orientation="Horizontal" Style="{StaticResource MenuItemStyle}">
                    <Image
                        x:Name="HomePage_Activities"
                        Width="30"
                        Height="30"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Source="/Views/Images/activities.png" />
                    <Label
                        x:Name="HomePage_lbActivities"
                        Width="108"
                        Height="30"
                        Margin="30,0,0,0"
                        Padding="0,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Content="Activities"
                        FontFamily="Segoe UI"
                        FontSize="20"
                        FontWeight="Bold" />
                </StackPanel>
            </Button>
            <Button
                x:Name="SidebarMemberButton"
                Width="160"
                Height="30"
                Margin="102,432,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="Transparent"
                BorderThickness="0"
                Click="SidebarMembersButton_Click"
                Cursor="Hand"
                Style="{StaticResource NavigationButtonStyle}">
                <StackPanel Orientation="Horizontal" Style="{StaticResource MenuItemStyle}">
                    <Image
                        x:Name="HomePage_Task_iMembers"
                        Width="30"
                        Height="30"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Source="/Views/Images/members.png" />
                    <Label
                        x:Name="HomePage_lbMembers"
                        Width="108"
                        Height="30"
                        Margin="30,0,0,0"
                        Padding="0,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Content="Members"
                        FontFamily="Segoe UI"
                        FontSize="20"
                        FontWeight="Bold" />
                </StackPanel>
            </Button>
            <Button
                x:Name="SidebarTaskButton"
                Width="160"
                Height="30"
                Margin="102,510,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="Transparent"
                BorderThickness="0"
                Click="SidebarTasksButton_Click"
                Cursor="Hand"
                Style="{StaticResource NavigationButtonStyle}">
                <StackPanel Orientation="Horizontal" Style="{StaticResource MenuItemStyle}">
                    <Image
                        x:Name="HomePage_iTasks"
                        Width="30"
                        Height="30"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Source="/Views/Images/tasks.png" />
                    <Label
                        x:Name="HomePage_lbTasks"
                        Width="108"
                        Height="30"
                        Margin="30,0,0,0"
                        Padding="0,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Content="Tasks"
                        FontFamily="Segoe UI"
                        FontSize="20"
                        FontWeight="Bold" />
                </StackPanel>
            </Button>
            <Button
                x:Name="SidebarAdminButton"
                Width="160"
                Height="30"
                Margin="102,586,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Background="Transparent"
                BorderThickness="0"
                Click="SidebarAdminButton_Click"
                Cursor="Hand"
                Style="{StaticResource NavigationButtonStyle}"
                Visibility="Collapsed">
                <StackPanel Orientation="Horizontal" Style="{StaticResource MenuItemStyle}">
                    <Image
                        x:Name="HomePage_iAdmin"
                        Width="30"
                        Height="30"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Source="/Views/Images/admin_panel.png" />
                    <Label
                        x:Name="HomePage_lbAdmin"
                        Width="108"
                        Height="30"
                        Margin="30,0,0,0"
                        Padding="0,0,0,0"
                        HorizontalAlignment="Left"
                        VerticalAlignment="Top"
                        Content="Admin"
                        FontFamily="Segoe UI"
                        FontSize="20"
                        FontWeight="Bold" />
                </StackPanel>
            </Button>

            <!--  Admin submenu  -->
            <StackPanel
                x:Name="AdminSubmenu"
                Margin="132,621,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Visibility="Collapsed">
                <Button
                    x:Name="AdminTaskButton"
                    Margin="0,5,0,5"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="AdminTaskButton_Click"
                    Cursor="Hand">
                    <TextBlock
                        FontSize="15"
                        Foreground="#042354"
                        Text="Quản lý công việc" />
                </Button>
                <Button
                    x:Name="AdminMembersButton"
                    Margin="0,5,0,5"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="AdminMembersButton_Click"
                    Cursor="Hand">
                    <TextBlock
                        FontSize="15"
                        Foreground="#042354"
                        Text="Quản lý thành viên" />
                </Button>
                <Button
                    x:Name="AdminChatButton"
                    Margin="0,5,0,5"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="AdminChatButton_Click"
                    Cursor="Hand">
                    <TextBlock
                        FontSize="15"
                        Foreground="#042354"
                        Text="Quản lý chat" />
                </Button>
                <Button
                    x:Name="AdminActivitiesButton"
                    Margin="0,5,0,5"
                    Background="Transparent"
                    BorderThickness="0"
                    Click="AdminActivitiesButton_Click"
                    Cursor="Hand">
                    <TextBlock
                        FontSize="15"
                        Foreground="#042354"
                        Text="Quản lý hoạt động" />
                </Button>
            </StackPanel>
            <!--  Logo  -->
            <Image
                x:Name="AdminChat_iLogo"
                Width="112.38"
                Height="40"
                Margin="131,71,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Source="/Views/Images/header.png" />

            <!--  Social Media Icons  -->
            <Image
                x:Name="AdminChat_iFacebook"
                Width="24"
                Height="24"
                Margin="175,926,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Source="/Views/Images/facebook.png" />
            <Image
                x:Name="AdminChat_iInstagram"
                Width="24"
                Height="24"
                Margin="135,926,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Source="/Views/Images/instagram.png" />
            <Image
                x:Name="AdminChat_iYoutube"
                Width="24"
                Height="24"
                Margin="215,926,0,0"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Source="/Views/Images/youtube.png" />

            <!--  Top icons  -->
            <StackPanel
                Margin="0,46,40,0"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Orientation="Horizontal">
                <Image
                    x:Name="ThemeToggleButton"
                    Width="40"
                    Height="40"
                    Margin="0,0,20,0"
                    MouseDown="ThemeToggleButton_MouseDown"
                    Source="/Views/Images/dark.png" />
                <Image
                    Width="40"
                    Height="40"
                    Margin="0,0,20,0"
                    Source="/Views/Images/light-notifications.png" />
                <Image
                    Width="40"
                    Height="40"
                    Source="/Views/Images/generic avatar.png" />
            </StackPanel>
            <!--  Tùy chỉnh cho Admin Chat  -->
            <TabControl Margin="370,119,40,40">
                <TabItem Header="Quản lý Trò chuyện">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="366*" />
                            <ColumnDefinition Width="634*" />
                        </Grid.ColumnDefinitions>

                        <!--  Danh sách cuộc trò chuyện bên trái  -->
                        <Border Background="#FFDBF3FF" CornerRadius="10,10,10,10">
                            <Grid>
                                <Grid Height="60" VerticalAlignment="Top">
                                    <Button
                                        Margin="0,0,10,0"
                                        Padding="8,5"
                                        HorizontalAlignment="Right"
                                        VerticalAlignment="Center"
                                        Background="#87ACCD"
                                        BorderThickness="0"
                                        Command="{Binding CreateGroupCommand}"
                                        Content="Tạo nhóm mới"
                                        Foreground="White" />

                                    <Button
                                        Margin="15,0,0,0"
                                        Padding="10,5"
                                        HorizontalAlignment="Left"
                                        VerticalAlignment="Center"
                                        Background="#87ACCD"
                                        BorderThickness="0"
                                        Command="{Binding SearchUsersCommand}"
                                        Content="Tìm người dùng"
                                        Foreground="White" />
                                </Grid>

                                <ScrollViewer Margin="0,60,0,0" VerticalScrollBarVisibility="Auto">
                                    <ListView
                                        Margin="15,0"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        ItemsSource="{Binding Conversations}"
                                        SelectedItem="{Binding SelectedConversation}">
                                        <ListView.ItemTemplate>
                                            <DataTemplate>
                                                <Border
                                                    Width="336"
                                                    Height="70"
                                                    Margin="0,5"
                                                    Background="#FFDAE9F6"
                                                    CornerRadius="10">
                                                    <Grid>
                                                        <Image
                                                            Width="44"
                                                            Height="44"
                                                            Margin="10,0,0,0"
                                                            HorizontalAlignment="Left"
                                                            VerticalAlignment="Center"
                                                            Source="/Views/Images/account_circle.png" />
                                                        <Label
                                                            Margin="60,10,0,0"
                                                            HorizontalAlignment="Left"
                                                            VerticalAlignment="Top"
                                                            Content="{Binding Converter={StaticResource ConversationTitleConverter}}" />
                                                        <Label
                                                            Margin="0,10,10,0"
                                                            HorizontalAlignment="Right"
                                                            VerticalAlignment="Top"
                                                            Content="{Binding LastActivity, Converter={StaticResource TimeZoneConverter}, ConverterParameter='HH:mm'}"
                                                            FontSize="10" />
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ListView.ItemTemplate>
                                    </ListView>
                                </ScrollViewer>
                            </Grid>
                        </Border>

                        <!--  Chat box hoặc spam management bên phải  -->
                        <Grid Grid.Column="1">
                            <TabControl>
                                <!--  Cập nhật nội dung tin nhắn trong AdminChatView.xaml  -->
                                <TabItem Header="Tin nhắn">
                                    <Border
                                        Margin="10"
                                        Background="White"
                                        CornerRadius="20">
                                        <Grid>
                                            <Grid.RowDefinitions>
                                                <RowDefinition Height="*" />
                                                <RowDefinition Height="Auto" />
                                            </Grid.RowDefinitions>

                                            <!--  Messages Area  -->
                                            <ScrollViewer
                                                x:Name="AdminMessageScrollViewer"
                                                Grid.Row="0"
                                                Margin="10"
                                                VerticalScrollBarVisibility="Auto">
                                                <ItemsControl ItemsSource="{Binding Messages}">
                                                    <ItemsControl.ItemTemplate>
                                                        <DataTemplate>
                                                            <Grid Margin="10,5">
                                                                <!--  Current user messages (right-aligned)  -->
                                                                <Border Style="{StaticResource CurrentUserMessageStyle}" Visibility="{Binding SenderId, Converter={StaticResource CurrentUserConverter}}">
                                                                    <StackPanel>
                                                                        <TextBlock
                                                                            Text="{Binding Content}"
                                                                            TextWrapping="Wrap"
                                                                            Visibility="{Binding Type, Converter={StaticResource MessageTypeToVisibilityConverter}, ConverterParameter=Text}" />

                                                                        <!--  Image attachments  -->
                                                                        <ItemsControl ItemsSource="{Binding Attachments}" Visibility="{Binding Type, Converter={StaticResource AttachmentTypeToVisibilityConverter}, ConverterParameter=Image}">
                                                                            <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                    <WrapPanel />
                                                                                </ItemsPanelTemplate>
                                                                            </ItemsControl.ItemsPanel>
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <ContentControl
                                                                                        Margin="2"
                                                                                        Content="{Binding}"
                                                                                        ContentTemplate="{StaticResource ImageAttachmentTemplate}" />
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>

                                                                        <!--  File attachments  -->
                                                                        <ItemsControl ItemsSource="{Binding Attachments}" Visibility="{Binding Type, Converter={StaticResource AttachmentTypeToVisibilityConverter}, ConverterParameter=File}">
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <ContentControl
                                                                                        Margin="2,2,2,0"
                                                                                        Content="{Binding}"
                                                                                        ContentTemplate="{StaticResource FileAttachmentTemplate}" />
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>

                                                                        <TextBlock
                                                                            HorizontalAlignment="Right"
                                                                            FontSize="10"
                                                                            Foreground="Gray"
                                                                            Text="{Binding Timestamp, Converter={StaticResource TimeZoneConverter}}" />
                                                                    </StackPanel>
                                                                </Border>

                                                                <!--  Other user messages (left-aligned)  -->
                                                                <Border Style="{StaticResource OtherUserMessageStyle}" Visibility="{Binding SenderId, Converter={StaticResource NotCurrentUserConverter}}">
                                                                    <StackPanel>
                                                                        <TextBlock
                                                                            FontSize="12"
                                                                            FontWeight="Bold"
                                                                            Text="{Binding SenderName}" />
                                                                        <TextBlock
                                                                            Text="{Binding Content}"
                                                                            TextWrapping="Wrap"
                                                                            Visibility="{Binding Type, Converter={StaticResource MessageTypeToVisibilityConverter}, ConverterParameter=Text}" />

                                                                        <!--  Image attachments  -->
                                                                        <ItemsControl ItemsSource="{Binding Attachments}" Visibility="{Binding Type, Converter={StaticResource AttachmentTypeToVisibilityConverter}, ConverterParameter=Image}">
                                                                            <ItemsControl.ItemsPanel>
                                                                                <ItemsPanelTemplate>
                                                                                    <WrapPanel />
                                                                                </ItemsPanelTemplate>
                                                                            </ItemsControl.ItemsPanel>
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <ContentControl
                                                                                        Margin="2"
                                                                                        Content="{Binding}"
                                                                                        ContentTemplate="{StaticResource ImageAttachmentTemplate}" />
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>

                                                                        <!--  File attachments  -->
                                                                        <ItemsControl ItemsSource="{Binding Attachments}" Visibility="{Binding Type, Converter={StaticResource AttachmentTypeToVisibilityConverter}, ConverterParameter=File}">
                                                                            <ItemsControl.ItemTemplate>
                                                                                <DataTemplate>
                                                                                    <ContentControl
                                                                                        Margin="2,2,2,0"
                                                                                        Content="{Binding}"
                                                                                        ContentTemplate="{StaticResource FileAttachmentTemplate}" />
                                                                                </DataTemplate>
                                                                            </ItemsControl.ItemTemplate>
                                                                        </ItemsControl>

                                                                        <TextBlock
                                                                            FontSize="10"
                                                                            Foreground="Gray"
                                                                            Text="{Binding Timestamp, Converter={StaticResource TimeZoneConverter}}" />
                                                                    </StackPanel>
                                                                </Border>
                                                            </Grid>
                                                        </DataTemplate>
                                                    </ItemsControl.ItemTemplate>
                                                </ItemsControl>
                                            </ScrollViewer>

                                            <!--  Input Area  -->
                                            <Border
                                                Grid.Row="1"
                                                Height="56"
                                                Background="#FFDAE9F6"
                                                CornerRadius="0,0,20,20">
                                                <Grid>
                                                    <TextBox
                                                        Margin="15,0,65,0"
                                                        VerticalAlignment="Center"
                                                        Background="Transparent"
                                                        BorderThickness="0"
                                                        Text="{Binding CurrentMessage, UpdateSourceTrigger=PropertyChanged}" />

                                                    <Button
                                                        Width="40"
                                                        Height="40"
                                                        Margin="0,0,15,0"
                                                        HorizontalAlignment="Right"
                                                        Command="{Binding SendMessageCommand}"
                                                        Style="{StaticResource SendButtonStyle}">
                                                        <Image
                                                            Width="19"
                                                            Height="24"
                                                            Source="/Views/Images/send.png" />
                                                    </Button>
                                                </Grid>
                                            </Border>
                                        </Grid>
                                    </Border>
                                </TabItem>
                                <TabItem Header="Tin nhắn Spam">
                                    <Border
                                        Margin="10"
                                        Background="White"
                                        CornerRadius="20">
                                        <ListBox ItemsSource="{Binding SpamMessages}">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Border
                                                        Margin="5"
                                                        Padding="10"
                                                        Background="#FFE8E8E8"
                                                        CornerRadius="10">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto" />
                                                                <RowDefinition Height="Auto" />
                                                                <RowDefinition Height="Auto" />
                                                            </Grid.RowDefinitions>
                                                            <TextBlock
                                                                Grid.Row="0"
                                                                FontWeight="Bold"
                                                                Text="{Binding SenderName}" />
                                                            <TextBlock
                                                                Grid.Row="1"
                                                                Margin="0,5"
                                                                Text="{Binding Content}" />
                                                            <StackPanel
                                                                Grid.Row="2"
                                                                HorizontalAlignment="Right"
                                                                Orientation="Horizontal">
                                                                <Button
                                                                    Margin="5,0"
                                                                    Command="{Binding DataContext.DeleteSpamCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                    CommandParameter="{Binding}"
                                                                    Content="Xóa" />
                                                                <Button
                                                                    Margin="5,0"
                                                                    Command="{Binding DataContext.RestoreMessageCommand, RelativeSource={RelativeSource AncestorType=ListBox}}"
                                                                    CommandParameter="{Binding}"
                                                                    Content="Khôi phục" />
                                                            </StackPanel>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </Border>
                                </TabItem>
                                <TabItem Header="Cài đặt Chat">
                                    <Border
                                        Margin="10"
                                        Background="White"
                                        CornerRadius="20">
                                        <StackPanel Margin="20">
                                            <TextBlock
                                                Margin="0,0,0,20"
                                                FontSize="18"
                                                FontWeight="Bold"
                                                Text="Cài đặt lọc spam" />
                                            <CheckBox
                                                Margin="0,5"
                                                Content="Tự động lọc tin nhắn spam"
                                                IsChecked="{Binding AutoFilterSpam}" />
                                            <CheckBox
                                                Margin="0,5"
                                                Content="Thông báo khi phát hiện spam"
                                                IsChecked="{Binding NotifyOnSpamDetection}" />
                                            <TextBlock Margin="0,15,0,5" Text="Mức lọc spam:" />
                                            <Slider
                                                IsSnapToTickEnabled="True"
                                                Maximum="10"
                                                Minimum="1"
                                                TickFrequency="1"
                                                TickPlacement="BottomRight"
                                                Value="{Binding SpamFilterLevel}" />
                                            <Button
                                                Margin="0,20,0,0"
                                                Padding="15,5"
                                                HorizontalAlignment="Left"
                                                Command="{Binding SaveSettingsCommand}"
                                                Content="Lưu cài đặt" />
                                        </StackPanel>
                                    </Border>
                                </TabItem>
                            </TabControl>
                        </Grid>
                    </Grid>
                </TabItem>
            </TabControl>
        </Grid>
    </Grid>
</Window>